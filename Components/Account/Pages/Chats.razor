@page "/chats"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using SiteZnakomstv.Data
@using Microsoft.EntityFrameworkCore
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject ApplicationDbContext _context
@inject AuthenticationStateProvider AuthenticationStateProvider

<h3>Мои чаты</h3>

@if (userChats == null)
{
    <p>Загрузка...</p>
}
else
{
    <ul class="list-group">
        @foreach (var chat in userChats)
        {
            var otherUser = chat.User1Id == CurrentUserId ? chat.User2 : chat.User1;
            var lastMessage = chat.Messages.OrderByDescending(m => m.SentAt).FirstOrDefault();
            var avatar = string.IsNullOrEmpty(otherUser.AvatarPath)
            ? "/avatars/default-avatar.png"
            : $"/avatars/{otherUser.AvatarPath}";

            <li class="list-group-item d-flex align-items-center"
                style="cursor:pointer;"
                @onclick="@(() => NavigationManager.NavigateTo($"/chat/{chat.Id}"))">

                <img src="@avatar" class="rounded-circle me-3" style="width:50px; height:50px; object-fit:cover;"
                     @onclick="@(() => NavigationManager.NavigateTo($"/profile/{otherUser.Id}"))"
                @onclick:stopPropagation />


                <div class="flex-grow-1">
                    <div class="fw-bold">@otherUser.Name @otherUser.Surname</div>
                    <div class="text-truncate" style="max-width:80%;">@lastMessage?.Text</div>
                </div>
                <div class="text-muted ms-2">@lastMessage?.SentAt.ToLocalTime().ToShortTimeString()</div>
            </li>
        }
    </ul>
}

@code {
    private string CurrentUserId = "";
    private List<Chatik> userChats = new();

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        CurrentUserId = UserManager.GetUserId(user);

        userChats = await _context.Chats
            .Include(c => c.User1)
            .Include(c => c.User2)
            .Include(c => c.Messages)
            .Where(c => c.User1Id == CurrentUserId || c.User2Id == CurrentUserId)
            .ToListAsync();
    }

    private void NavigateToProfile(string userId, MouseEventArgs e)
    {
        NavigationManager.NavigateTo($"/profile/{userId}");
    }
}
