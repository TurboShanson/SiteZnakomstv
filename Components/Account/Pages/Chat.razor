@page "/chat/{ChatId:int}"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Identity
@using SiteZnakomstv.Data
@using Microsoft.EntityFrameworkCore
@using System.Timers
@implements IDisposable

@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavigationManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JS

<PageTitle>@PageTitleText</PageTitle>


<div class="chat-container d-flex flex-column mx-auto" style="height:calc(100vh - 70px); width:70%;">

    <!-- Область сообщений -->
    <div class="chat-window flex-grow-1 p-3 border overflow-auto">
        @foreach (var msg in Messages)
        {
            @if (msg.SenderId == CurrentUserId)
            {
                <div class="message d-flex justify-content-end mb-2">
                    <div class="message-content text-white bg-primary">
                        @msg.Text
                        <br />
                        <small class="text-light">@msg.SentAt.ToLocalTime().ToShortTimeString()</small>
                    </div>
                </div>
            }
            else
            {
                <div class="message text-start d-flex align-items-start mb-2">
                    <img src="@msg.AvatarUrl" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;"
                         @onclick="@(() => NavigationManager.NavigateTo($"/profile/{msg.SenderId}"))"
                    @onclick:stopPropagation />
                    <div class="message-content bg-light text-dark">
                        <strong>@msg.SenderName</strong>: @msg.Text
                        <br />
                        <small class="text-muted">@msg.SentAt.ToLocalTime().ToShortTimeString()</small>
                    </div>
                </div>
            }
        }
    </div>

    <!-- Поле ввода -->
    <div class="chat-input d-flex p-2 border-top" style="height:60px;">
        <input type="text"
               class="form-control me-2"
               placeholder="Написать сообщение..."
               style="height:40px;"
               @bind="NewMessage"
               @onkeydown="CheckEnter" />
        <button class="btn btn-primary" style="height:40px;" @onclick="SendMessage">Отправить</button>
    </div>
</div>

@code {
    [Parameter] public int ChatId { get; set; }

    private List<(string SenderId, string SenderName, string Text, DateTime SentAt, string AvatarUrl)> Messages = new();
    private string NewMessage = "";
    private string CurrentUserId = "";
    private Timer? _refreshTimer;
    private DateTime _lastUpdate = DateTime.UtcNow;
    private bool _isLoading = false;
    private string PageTitleText = "Чат"; // Заголовок по умолчанию
    private string? OtherUserName;


    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        CurrentUserId = UserManager.GetUserId(user);

        await LoadMessages();

        _refreshTimer = new Timer(2000);
        _refreshTimer.Elapsed += async (sender, e) => await RefreshMessages();
        _refreshTimer.AutoReset = true;
        _refreshTimer.Enabled = true;
    }

    private async Task LoadMessages()
    {
        _isLoading = true;

        await using var db = await DbFactory.CreateDbContextAsync();

        var chat = await db.Chats
            .Include(c => c.Messages.OrderBy(m => m.SentAt))
                .ThenInclude(m => m.Sender)
            .FirstOrDefaultAsync(c => c.Id == ChatId);

        Messages.Clear();
        if (chat != null)
        {
            foreach (var m in chat.Messages)
            {
                var avatar = string.IsNullOrEmpty(m.Sender.AvatarPath)
                    ? "/avatars/default-avatar.png"
                    : $"/avatars/{m.Sender.AvatarPath}";

                Messages.Add((m.SenderId, m.Sender.Name, m.Text, m.SentAt, avatar));
            }

            _lastUpdate = chat.Messages.Any() ? chat.Messages.Max(m => m.SentAt) : DateTime.UtcNow;
        }

        _isLoading = false;
        StateHasChanged();
        await ScrollToBottom();

        var otherUser = chat.User1Id == CurrentUserId
    ? await db.Users.FindAsync(chat.User2Id)
    : await db.Users.FindAsync(chat.User1Id);

        OtherUserName = otherUser != null ? $"{otherUser.Name} {otherUser.Surname}" : "Чат";
        PageTitleText = OtherUserName;
        StateHasChanged();

    }

    private async Task RefreshMessages()
    {
        if (_isLoading) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var hasNewMessages = await db.Messages
            .Include(m => m.Sender)
            .Where(m => m.ChatId == ChatId && m.SentAt > _lastUpdate)
            .AnyAsync();

        if (hasNewMessages)
        {
            await InvokeAsync(async () =>
            {
                await LoadMessages();
            });
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(NewMessage)) return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var msg = new Message
            {
                ChatId = ChatId,
                SenderId = CurrentUserId,
                Text = NewMessage,
                SentAt = DateTime.UtcNow
            };

        db.Messages.Add(msg);
        await db.SaveChangesAsync();

        _lastUpdate = msg.SentAt;

        var sender = await db.Users.FindAsync(CurrentUserId);
        var avatar = string.IsNullOrEmpty(sender?.AvatarPath)
            ? "/avatars/default-avatar.png"
            : $"/avatars/{sender.AvatarPath}";

        Messages.Add((CurrentUserId, sender?.Name ?? "Вы", NewMessage, msg.SentAt, avatar));

        NewMessage = "";
        StateHasChanged();
        await ScrollToBottom();
    }

    private async Task CheckEnter(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
            await SendMessage();
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JS.InvokeVoidAsync("eval",
                "var chatWindow = document.querySelector('.chat-window');" +
                "if (chatWindow) chatWindow.scrollTop = chatWindow.scrollHeight;");
        }
        catch { }
    }

    public void Dispose()
    {
        _refreshTimer?.Stop();
        _refreshTimer?.Dispose();
    }
}


<style>
    .chat-window {
        flex-grow: 1;
        padding: 1rem;
        border: 1px solid #dee2e6;
        overflow-y: auto;
    }

        .chat-window .message {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            width: 100%;
        }

        .chat-window .message-content {
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            max-width: 85%;
            word-wrap: break-word;
        }

        /* Свои сообщения справа */
        .chat-window .justify-content-end .message-content {
            background-color: #ffe6f0; /* светло-розовый фон */
            color: #212529; /* тёмный текст */
        }

        /* Сообщения собеседника слева */
        .chat-window .text-start .message-content {
            background-color: #f8f0f5; /* немного светлее розовый */
            color: #212529;
        }

        .chat-window img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }

    .chat-input {
        display: flex;
        padding: 0.5rem;
        border-top: 1px solid #dee2e6;
        height: 60px;
        background-color: #f8f9fa;
    }

        .chat-input input {
            height: 40px;
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 0.25rem 0.5rem;
            transition: border-color 0.3s;
        }

            .chat-input input:focus {
                border-color: #ff4d6d; /* розовый цвет при фокусе */
                outline: none;
                box-shadow: 0 0 5px rgba(255, 77, 109, 0.5);
            }

        .chat-input button {
            height: 40px;
            background: linear-gradient(135deg, #ff4d6d, #ffb3c1);
            border: none;
            color: #fff;
            font-weight: bold;
            padding: 0 1.5rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }

            .chat-input button:hover {
                background-color: #ff1f4b;
                transform: translateY(-2px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            }
</style>
