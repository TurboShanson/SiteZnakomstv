@page "/profile/{UserId}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using SiteZnakomstv.Data

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<h3>@ProfileUser?.Name @ProfileUser?.Surname</h3>

@if (ProfileUser != null)
{
    <img src="@AvatarUrl"
         width="150"
         height="150"
         class="rounded-circle mb-3"
         style="object-fit:cover;" />

    <p>@ProfileUser.Info</p>
    <p>Город: @ProfileUser.City</p>
    <p>Пол: @ProfileUser.Gender</p>
    <p>Дата рождения: @ProfileUser.BirthDate?.ToShortDateString()</p>
    <p>Интересы: @string.Join(", ", UserInterests.Select(i => i.Name))</p>

    @if (!IsOwnProfile)
    {
        <button class="btn btn-primary" @onclick="StartChat">
            Сообщение
        </button>
    }
    else
    {
        <button class="btn btn-primary" @onclick="EditProfile">
            Редактировать
        </button>
    }
}

@code {
    [Parameter] public string UserId { get; set; } = "";

    private ApplicationUser? ProfileUser;
    private List<Interest> UserInterests = new();
    private string? CurrentUserId;

    private bool IsOwnProfile =>
        ProfileUser != null && ProfileUser.Id == CurrentUserId;

    private string AvatarUrl =>
        string.IsNullOrEmpty(ProfileUser?.AvatarPath)
            ? "/avatars/default-avatar.png"
            : $"/avatars/{ProfileUser.AvatarPath}";

    protected override async Task OnInitializedAsync()
    {
        // текущий пользователь
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            CurrentUserId = UserManager.GetUserId(authState.User);
        }

        // ⚠ НОВЫЙ DbContext
        await using var db = await DbFactory.CreateDbContextAsync();

        ProfileUser = await db.Users
            .AsNoTracking()
            .FirstOrDefaultAsync(u => u.Id == UserId);

        if (ProfileUser != null)
        {
            UserInterests = await db.Interests
                .AsNoTracking()
                .Where(i => i.UserId == UserId)
                .ToListAsync();
        }
    }

    private async Task StartChat()
    {
        if (ProfileUser == null || CurrentUserId == null)
            return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var chat = await db.Chats
            .FirstOrDefaultAsync(c =>
                (c.User1Id == CurrentUserId && c.User2Id == ProfileUser.Id) ||
                (c.User1Id == ProfileUser.Id && c.User2Id == CurrentUserId));

        if (chat == null)
        {
            chat = new Chatik
                {
                    User1Id = CurrentUserId,
                    User2Id = ProfileUser.Id
                };

            db.Chats.Add(chat);
            await db.SaveChangesAsync();
        }

        NavigationManager.NavigateTo($"/chat/{chat.Id}");
    }

    private void EditProfile()
    {
        NavigationManager.NavigateTo("/profile/edit");
    }
}
