@page "/profile/{UserId}"
@rendermode InteractiveServer

@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using SiteZnakomstv.Data

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject NavigationManager NavigationManager

<PageTitle>Профиль</PageTitle>

<div class="profile-card mx-auto p-4 shadow rounded text-center">
    @if (ProfileUser != null)
    {
        <img src="@AvatarUrl"
             class="rounded-circle profile-avatar mb-3" />

        <h3 class="mb-2">@ProfileUser.Name @ProfileUser.Surname</h3>
        <p class="text-muted">@ProfileUser.Info</p>

        <div class="profile-details text-start mt-4">
            <p><strong>Город:</strong> @ProfileUser.City</p>
            <p><strong>Пол:</strong> @ProfileUser.Gender</p>
            <p><strong>Дата рождения:</strong> @ProfileUser.BirthDate?.ToShortDateString()</p>
            <p><strong>Интересы:</strong> @string.Join(", ", UserInterests.Select(i => i.Name))</p>
        </div>

        <div class="mt-4">
            @if (!IsOwnProfile)
            {
                <button class="btn btn-gradient me-2" @onclick="StartChat">
                    💌 Сообщение
                </button>
            }
            else
            {
                <button class="btn btn-gradient" @onclick="EditProfile">
                    ✏️ Редактировать
                </button>
            }
        </div>
    }
    else
    {
        <p>Загрузка профиля...</p>
    }
</div>

<style>
    .profile-card {
        max-width: 500px;
        background: linear-gradient(135deg, #ffccd5, #ff99ac);
        color: #000;
        border-radius: 1rem;
    }

    .profile-avatar {
        width: 150px;
        height: 150px;
        object-fit: cover;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .profile-details p {
        font-size: 1rem;
        margin: 0.5rem 0;
    }

    .btn-gradient {
        background: linear-gradient(135deg, #ff4d6d, #ffb3c1);
        color: #fff;
        font-weight: bold;
        padding: 0.6rem 1.5rem;
        border-radius: 50px;
        border: none;
        transition: all 0.3s ease;
        font-size: 1rem;
    }

        .btn-gradient:hover {
            background-color: #ff1f4b;
            color: #fff;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
</style>

@code {
    [Parameter] public string UserId { get; set; } = "";

    private ApplicationUser? ProfileUser;
    private List<Interest> UserInterests = new();
    private string? CurrentUserId;

    private bool IsOwnProfile =>
        ProfileUser != null && ProfileUser.Id == CurrentUserId;

    private string AvatarUrl =>
        string.IsNullOrEmpty(ProfileUser?.AvatarPath)
            ? "/avatars/default-avatar.png"
            : $"/avatars/{ProfileUser.AvatarPath}";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated == true)
        {
            CurrentUserId = UserManager.GetUserId(authState.User);
        }

        await using var db = await DbFactory.CreateDbContextAsync();

        ProfileUser = await db.Users
            .AsNoTracking()
            .FirstOrDefaultAsync(u => u.Id == UserId);

        if (ProfileUser != null)
        {
            UserInterests = await db.Interests
                .AsNoTracking()
                .Where(i => i.UserId == UserId)
                .ToListAsync();
        }
    }

    private async Task StartChat()
    {
        if (ProfileUser == null || CurrentUserId == null)
            return;

        await using var db = await DbFactory.CreateDbContextAsync();

        var chat = await db.Chats
            .FirstOrDefaultAsync(c =>
                (c.User1Id == CurrentUserId && c.User2Id == ProfileUser.Id) ||
                (c.User1Id == ProfileUser.Id && c.User2Id == CurrentUserId));

        if (chat == null)
        {
            chat = new Chatik
                {
                    User1Id = CurrentUserId,
                    User2Id = ProfileUser.Id
                };

            db.Chats.Add(chat);
            await db.SaveChangesAsync();
        }

        NavigationManager.NavigateTo($"/chat/{chat.Id}");
    }

    private void EditProfile()
    {
        NavigationManager.NavigateTo("/profile/edit");
    }
}
